name: CI Preload-ng Daemon

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: üõë Checkout do C√≥digo
        uses: actions/checkout@v4

      - name: üõ†Ô∏è Instalar Depend√™ncias de Build (Autotools & GLib)
        run: |
          # build-essential: Instala gcc, make, etc.
          # autotools: Ferramentas de configura√ß√£o.
          # libglib2.0-dev: Depend√™ncia cr√≠tica do projeto (GLib >= 2.14).
          # help2man: Remove warnings de man page
          sudo apt-get update
          sudo apt-get install -y build-essential autoconf automake libtool pkg-config libglib2.0-dev help2man

      - name: üèóÔ∏è Configurar, Compilar e Testar Projeto
        run: |
          cd preload-src
          
          # 1. Configurar
          autoreconf -i
          ./configure
          
          # 2. Compilar: Cria o execut√°vel 'preload-ng' e os scripts de teste
          make
          
          # 3. Aplicar Permiss√£o de Execu√ß√£o (APENAS NO runtests.sh)
          # 'test-driver' √© gerado e deve ter permiss√£o correta.
          chmod +x src/runtests.sh
          
          # 4. Testar (Com L√≥gica de Debug)
          echo "--- Iniciando Testes (make check) ---"
          if ! make check; then
            echo "--- Falha nos Testes. Exibindo Conte√∫do de test-suite.log ---"
            cat src/test-suite.log
            exit 1
          fi
          echo "--- Testes Conclu√≠dos com Sucesso ---"

      - name: üì¶ Upload de Bin√°rio (preload-ng)
        uses: actions/upload-artifact@v4
        with:
          name: preload-ng-daemon
          path: ./preload-src/src/preload-ng
