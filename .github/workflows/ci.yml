name: CI Preload-ng Daemon

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ›‘ Checkout do CÃ³digo
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Instalar DependÃªncias de Build (Autotools & GLib)
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential autoconf automake libtool pkg-config libglib2.0-dev
          # Opcional: Instala help2man para remover o WARNING
          sudo apt-get install -y help2man

      - name: ğŸ—ï¸ Configurar, Compilar e Testar Projeto
        run: |
          cd preload-src
          
          # 1. Configurar
          autoreconf -i
          ./configure
          
          # 2. Aplicar PermissÃ£o de ExecuÃ§Ã£o (NOVA CORREÃ‡ÃƒO)
          chmod +x src/runtests.sh
          # Adicione o test-driver tambÃ©m por seguranÃ§a, embora geralmente seja gerado com permissÃ£o
          chmod +x src/test-driver
          
          # 3. Compilar
          make
          
          # 4. Testar (Com LÃ³gica de Debug)
          echo "--- Iniciando Testes (make check) ---"
          if ! make check; then
            echo "--- Falha nos Testes. Exibindo ConteÃºdo de test-suite.log ---"
            cat src/test-suite.log
            exit 1
          fi
          echo "--- Testes ConcluÃ­dos com Sucesso ---"

      - name: ğŸ“¦ Upload de BinÃ¡rio (preload-ng)
        uses: actions/upload-artifact@v4
        with:
          name: preload-ng-daemon
          path: ./preload-src/src/preload-ng
