name: CI Preload-ng Daemon

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: üõë Checkout do C√≥digo
        uses: actions/checkout@v4

      - name: üõ†Ô∏è Instalar Depend√™ncias de Build (Autotools & GLib)
        run: |
          # build-essential: Instala gcc, make, etc.
          # autotools: Ferramentas de configura√ß√£o.
          # libglib2.0-dev: Depend√™ncia cr√≠tica do projeto (GLib >= 2.14).
          sudo apt-get update
          sudo apt-get install -y build-essential autoconf automake libtool pkg-config libglib2.0-dev

      - name: üèóÔ∏è Configurar, Compilar e Testar Projeto
        # Executando todas as etapas de build dentro do subdiret√≥rio 'preload-src' 
        # garante que o 'make' encontre o 'Makefile' gerado por './configure'.
        run: |
          cd preload-src
          
          # 1. Configurar
          autoreconf -i
          ./configure
          
          # 2. Compilar
          make
          
          # 3. Testar (Com L√≥gica de Debug)
          echo "--- Iniciando Testes (make check) ---"
          if ! make check; then
            echo "--- Falha nos Testes. Exibindo Conte√∫do de test-suite.log ---"
            # O log de falha √© gerado em preload-src/src/test-suite.log
            cat src/test-suite.log
            exit 1 # For√ßa a falha do job
          fi
          echo "--- Testes Conclu√≠dos com Sucesso ---"
        uses: actions/upload-artifact@v4
        with:
          name: preload-ng-daemon
          path: ./preload-src/src/preload-ng
