name: Dependabot Auto-Merge

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  pull_request_review:
    types: [submitted]
  check_run:
    types: [completed]

jobs:
  automerge:
    # Apenas executa se o PR foi aberto pelo Dependabot
    if: github.actor == 'dependabot[bot]'
    runs-on: ubuntu-latest
    
    steps:
      - name: üîê Configurar GitHub CLI
        uses: actions/setup-gh@v2
        with:
          token: ${{ secrets.GITHUB_TOKEN }} # Token padr√£o do GitHub

      - name: üîÑ Habilitar Auto-Merge se for seguro
        # O script verifica as condi√ß√µes de seguran√ßa antes de habilitar o auto-merge
        run: |
          PR_URL=${{ github.event.pull_request.html_url }}
          PR_NUMBER=$(basename $PR_URL)
          
          # 1. Verifica se o PR foi aprovado ou se n√£o precisa de aprova√ß√£o
          APPROVALS=$(gh pr checks $PR_NUMBER --json checks --jq '.[].checks.state | select(. == "SUCCESS" or . == "SKIPPED")')
          
          # 2. Verifica se a su√≠te de CI foi conclu√≠da com sucesso
          CI_STATUS=$(gh pr checks $PR_NUMBER --json status --jq '.status')
          
          # A√ß√£o: Habilita o auto-merge APENAS se o status do CI for "SUCCESS"
          if [[ "$CI_STATUS" == "SUCCESS" ]]; then
            echo "CI conclu√≠do com sucesso. Habilitando auto-merge."
            
            # Comando para habilitar o auto-merge, usando 'merge' como m√©todo
            gh pr merge $PR_NUMBER --auto --merge
            
          else
            echo "CI status n√£o √© SUCCESS. Merge autom√°tico n√£o habilitado."
            exit 0
          fi
